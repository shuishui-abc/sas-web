{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROG/Desktop/sas/sas-web/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\";\r\n\r\nlet pool;\r\n\r\nexport default function getPool() {\r\n  if (!pool) {\r\n    pool = mysql.createPool({\r\n      host: process.env.MYSQL_HOST || \"127.0.0.1\",\r\n      port: Number(process.env.MYSQL_PORT || 3306),\r\n      user: process.env.MYSQL_USER || \"root\",\r\n      password: process.env.MYSQL_PASSWORD || \"002025\",\r\n      database: process.env.MYSQL_DATABASE || \"sas_app\",\r\n      waitForConnections: true,\r\n      connectionLimit: 10,\r\n      queueLimit: 0,\r\n      timezone: \"Z\",\r\n    });\r\n  }\r\n  return pool;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI;AAEW,SAAS;IACtB,IAAI,CAAC,MAAM;QACT,OAAO,mNAAK,CAAC,UAAU,CAAC;YACtB,MAAM,QAAQ,GAAG,CAAC,UAAU,IAAI;YAChC,MAAM,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;YACvC,MAAM,QAAQ,GAAG,CAAC,UAAU,IAAI;YAChC,UAAU,QAAQ,GAAG,CAAC,cAAc,IAAI;YACxC,UAAU,QAAQ,GAAG,CAAC,cAAc,IAAI;YACxC,oBAAoB;YACpB,iBAAiB;YACjB,YAAY;YACZ,UAAU;QACZ;IACF;IACA,OAAO;AACT"}},
    {"offset": {"line": 49, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROG/Desktop/sas/sas-web/lib/score.js"],"sourcesContent":["// lib/score.js\r\nexport function scoreSAS(answersById) {\r\n  const reverseIds = new Set([5, 9, 13, 17, 19]);\r\n\r\n  let raw = 0;\r\n  for (let i = 1; i <= 20; i++) {\r\n    const v = Number(answersById[i]);\r\n    if (![1, 2, 3, 4].includes(v)) {\r\n      throw new Error(`Invalid answer for Q${i}: ${answersById[i]}`);\r\n    }\r\n    raw += reverseIds.has(i) ? (5 - v) : v;\r\n  }\r\n\r\n  const standard = Math.round(raw * 1.25);\r\n\r\n  let level = \"正常\";\r\n  if (standard >= 70) level = \"重度焦虑\";\r\n  else if (standard >= 60) level = \"中度焦虑\";\r\n  else if (standard >= 50) level = \"轻度焦虑\";\r\n\r\n  return { raw, standard, level };\r\n}\r\n"],"names":[],"mappings":"AAAA,eAAe;;;;;AACR,SAAS,SAAS,WAAW;IAClC,MAAM,aAAa,IAAI,IAAI;QAAC;QAAG;QAAG;QAAI;QAAI;KAAG;IAE7C,IAAI,MAAM;IACV,IAAK,IAAI,IAAI,GAAG,KAAK,IAAI,IAAK;QAC5B,MAAM,IAAI,OAAO,WAAW,CAAC,EAAE;QAC/B,IAAI,CAAC;YAAC;YAAG;YAAG;YAAG;SAAE,CAAC,QAAQ,CAAC,IAAI;YAC7B,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,EAAE,EAAE,EAAE,WAAW,CAAC,EAAE,EAAE;QAC/D;QACA,OAAO,WAAW,GAAG,CAAC,KAAM,IAAI,IAAK;IACvC;IAEA,MAAM,WAAW,KAAK,KAAK,CAAC,MAAM;IAElC,IAAI,QAAQ;IACZ,IAAI,YAAY,IAAI,QAAQ;SACvB,IAAI,YAAY,IAAI,QAAQ;SAC5B,IAAI,YAAY,IAAI,QAAQ;IAEjC,OAAO;QAAE;QAAK;QAAU;IAAM;AAChC"}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROG/Desktop/sas/sas-web/pages/api/sas_submit.js"],"sourcesContent":["import { Buffer } from \"buffer\";\r\nimport getPool from \"../../lib/db.js\";\r\nimport { scoreSAS } from \"../../lib/score.js\";\r\n\r\nfunction json(res, status, data) {\r\n  res.statusCode = status;\r\n  res.setHeader(\"Content-Type\", \"application/json; charset=utf-8\");\r\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n  res.setHeader(\"Access-Control-Allow-Methods\", \"POST,OPTIONS\");\r\n  res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type, Authorization\");\r\n  res.end(JSON.stringify(data));\r\n}\r\n\r\nasync function readJson(req) {\r\n  if (\r\n    req.body &&\r\n    typeof req.body === \"object\" &&\r\n    (Object.prototype.hasOwnProperty.call(req.body, \"phone\") ||\r\n      Object.prototype.hasOwnProperty.call(req.body, \"answers\"))\r\n  ) {\r\n    return req.body;\r\n  }\r\n\r\n  if (typeof req.body === \"string\") {\r\n    const raw = req.body.replace(/^\\uFEFF/, \"\").trim();\r\n    if (!raw) return {};\r\n    if (!(raw.startsWith(\"{\") || raw.startsWith(\"[\"))) throw new Error(\"Invalid JSON\");\r\n    return JSON.parse(raw);\r\n  }\r\n\r\n  const chunks = [];\r\n  for await (const chunk of req) chunks.push(chunk);\r\n\r\n  let raw = Buffer.concat(chunks).toString(\"utf8\");\r\n  raw = raw.replace(/^\\uFEFF/, \"\").trim();\r\n  if (!raw) return {};\r\n  if (!(raw.startsWith(\"{\") || raw.startsWith(\"[\"))) throw new Error(\"Invalid JSON\");\r\n  return JSON.parse(raw);\r\n}\r\n\r\nfunction normalizeSex(v) {\r\n  if (v == null) return null;\r\n  const s = String(v).trim().toLowerCase();\r\n  if (!s) return null;\r\n  if ([\"m\", \"male\", \"man\", \"男\", \"1\"].includes(s)) return \"M\";\r\n  if ([\"f\", \"female\", \"woman\", \"女\", \"0\", \"2\"].includes(s)) return \"F\";\r\n  return \"U\";\r\n}\r\n\r\nfunction normalizeAge(v) {\r\n  if (v == null || v === \"\") return null;\r\n  const n = Number(v);\r\n  if (!Number.isFinite(n)) return null;\r\n  if (n < 0 || n > 120) return null;\r\n  return Math.floor(n);\r\n}\r\n\r\nexport default async function handler(req, res) {\r\n  try {\r\n    if (req.headers && req.headers.expect) delete req.headers.expect;\r\n  } catch {}\r\n\r\n  if (req.method === \"OPTIONS\") return res.status(204).end();\r\n  if (req.method !== \"POST\") return json(res, 405, { error: \"Method Not Allowed\" });\r\n\r\n  try {\r\n    const body = await readJson(req);\r\n    const { name, sex, age, phone, answers } = body || {};\r\n\r\n    if (!phone || typeof phone !== \"string\" || !phone.trim()) {\r\n      return json(res, 400, { error: \"phone is required\" });\r\n    }\r\n    if (!answers || typeof answers !== \"object\") {\r\n      return json(res, 400, { error: \"answers is required\" });\r\n    }\r\n\r\n    const phoneNorm = phone.trim();\r\n    const nameNorm = name == null ? null : String(name).trim() || null;\r\n    const sexNorm = normalizeSex(sex);\r\n    const ageNorm = normalizeAge(age);\r\n\r\n    // 1..20 强制齐全且为 1..4\r\n    const normAnswers = {};\r\n    for (let i = 1; i <= 20; i++) {\r\n      const v = answers[i] ?? answers[String(i)];\r\n      if (v == null) return json(res, 400, { error: `answer ${i} is required` });\r\n\r\n      const num = Number(v);\r\n      if (![1, 2, 3, 4].includes(num)) {\r\n        return json(res, 400, { error: `answer ${i} must be 1..4` });\r\n      }\r\n      normAnswers[i] = num;\r\n    }\r\n\r\n    // 计分（raw/standard/level）——仍然以 score.js 为准\r\n    const { raw, standard, level } = scoreSAS(normAnswers);\r\n\r\n    const pool = getPool();\r\n    const conn = await pool.getConnection();\r\n\r\n    try {\r\n      await conn.beginTransaction();\r\n\r\n      // users：phone 唯一，允许 name null（你已改表）\r\n      await conn.query(\r\n        `\r\n        INSERT INTO users (name, sex, age, phone)\r\n        VALUES (?, ?, ?, ?)\r\n        ON DUPLICATE KEY UPDATE\r\n          name = VALUES(name),\r\n          sex  = VALUES(sex),\r\n          age  = VALUES(age)\r\n        `,\r\n        [nameNorm, sexNorm, ageNorm, phoneNorm]\r\n      );\r\n\r\n      const [uRows] = await conn.query(\r\n        `SELECT id FROM users WHERE phone = ? LIMIT 1`,\r\n        [phoneNorm]\r\n      );\r\n      if (!uRows?.length) throw new Error(\"User upsert failed\");\r\n      const userId = uRows[0].id;\r\n\r\n      // assessments：你已加 scale 列\r\n      const [assessRes] = await conn.query(\r\n        `\r\n        INSERT INTO assessments (user_id, scale, raw_score, standard_score, level)\r\n        VALUES (?, 'SAS', ?, ?, ?)\r\n        `,\r\n        [userId, raw, standard, level]\r\n      );\r\n      const assessmentId = assessRes.insertId;\r\n\r\n      // assessment_answers：用你真实列名 answer_value / scored_value\r\n      // 你的表里已经有 question_id、question_no、answer_value、scored_value\r\n      const rows = [];\r\n      for (let q = 1; q <= 20; q++) {\r\n        const answerValue = normAnswers[q];\r\n        // 先把 scored_value 暂时等于 answer_value（不做反向；反向可以以后统一在 score.js 或 SQL 更新）\r\n        const scoredValue = answerValue;\r\n\r\n        rows.push([assessmentId, q, q, answerValue, scoredValue]);\r\n      }\r\n\r\n      await conn.query(\r\n        `\r\n        INSERT INTO assessment_answers\r\n          (assessment_id, question_id, question_no, answer_value, scored_value)\r\n        VALUES ?\r\n        `,\r\n        [rows]\r\n      );\r\n\r\n      await conn.commit();\r\n\r\n      return json(res, 200, {\r\n        ok: true,\r\n        id: assessmentId,\r\n        assessmentId,\r\n        score: { raw, standard, level },\r\n      });\r\n    } catch (e) {\r\n      await conn.rollback();\r\n      throw e;\r\n    } finally {\r\n      conn.release();\r\n    }\r\n  } catch (err) {\r\n    return json(res, 500, { error: String(err.message || err) });\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}