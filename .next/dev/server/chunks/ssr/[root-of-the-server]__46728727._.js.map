{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROG/Desktop/sas/sas-web/pages/index.js"],"sourcesContent":["import { Buffer } from \"buffer\";\r\nimport getPool from \"../../lib/db.js\";\r\nimport { scoreSAS } from \"../../lib/score.js\";\r\n\r\n/* ---------- 工具函数 ---------- */\r\nfunction json(res, status, data) {\r\n  res.statusCode = status;\r\n  res.setHeader(\"Content-Type\", \"application/json; charset=utf-8\");\r\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n  res.setHeader(\"Access-Control-Allow-Methods\", \"POST,OPTIONS\");\r\n  res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type, Authorization\");\r\n  res.end(JSON.stringify(data));\r\n}\r\n\r\n/**\r\n * 稳定读取 JSON\r\n * - 只有当 req.body 明确包含 phone / answers 时才信任\r\n * - 否则一律从原始 stream 读取\r\n */\r\nasync function readJson(req) {\r\n  // 1) Next 已解析，且字段齐全\r\n  if (\r\n    req.body &&\r\n    typeof req.body === \"object\" &&\r\n    (Object.prototype.hasOwnProperty.call(req.body, \"phone\") ||\r\n      Object.prototype.hasOwnProperty.call(req.body, \"answers\"))\r\n  ) {\r\n    return req.body;\r\n  }\r\n\r\n  // 2) body 是字符串\r\n  if (typeof req.body === \"string\") {\r\n    const raw = req.body.replace(/^\\uFEFF/, \"\").trim();\r\n    if (!raw) return {};\r\n    if (!(raw.startsWith(\"{\") || raw.startsWith(\"[\"))) throw new Error(\"Invalid JSON\");\r\n    return JSON.parse(raw);\r\n  }\r\n\r\n  // 3) 兜底：从原始请求流读取\r\n  const chunks = [];\r\n  for await (const chunk of req) chunks.push(chunk);\r\n\r\n  let raw = Buffer.concat(chunks).toString(\"utf8\");\r\n  raw = raw.replace(/^\\uFEFF/, \"\").trim();\r\n\r\n  if (!raw) return {};\r\n  if (!(raw.startsWith(\"{\") || raw.startsWith(\"[\"))) throw new Error(\"Invalid JSON\");\r\n\r\n  return JSON.parse(raw);\r\n}\r\n\r\n/* ---------- 规范化工具 ---------- */\r\nfunction normalizeSex(v) {\r\n  if (v == null) return null;\r\n  const s = String(v).trim().toLowerCase();\r\n  if (!s) return null;\r\n\r\n  // 男\r\n  if ([\"m\", \"male\", \"man\", \"男\", \"1\"].includes(s)) return \"M\";\r\n  // 女\r\n  if ([\"f\", \"female\", \"woman\", \"女\", \"0\", \"2\"].includes(s)) return \"F\";\r\n  // 未知/其他\r\n  if ([\"u\", \"unknown\", \"其他\", \"未知\", \"不详\", \"na\", \"n/a\"].includes(s)) return \"U\";\r\n\r\n  // 兜底：首字符\r\n  const c = s[0];\r\n  if (c === \"m\") return \"M\";\r\n  if (c === \"f\") return \"F\";\r\n  return \"U\";\r\n}\r\n\r\nfunction normalizeAge(v) {\r\n  if (v == null || v === \"\") return null;\r\n  const n = Number(v);\r\n  if (!Number.isFinite(n)) return null;\r\n  // 可按需调整范围\r\n  if (n < 0 || n > 120) return null;\r\n  return Math.floor(n);\r\n}\r\n\r\n/* ---------- API Handler ---------- */\r\nexport default async function handler(req, res) {\r\n  // 忽略 Expect: 100-continue（某些环境下会导致 undici 报错）\r\n  try {\r\n    if (req.headers && req.headers.expect) delete req.headers.expect;\r\n  } catch {}\r\n\r\n  if (req.method === \"OPTIONS\") return res.status(204).end();\r\n  if (req.method !== \"POST\") return json(res, 405, { error: \"Method Not Allowed\" });\r\n\r\n  try {\r\n    const body = await readJson(req);\r\n    const { name, sex, age, phone, answers } = body || {};\r\n\r\n    /* ---------- 基础校验 ---------- */\r\n    if (!phone || typeof phone !== \"string\" || !phone.trim()) {\r\n      return json(res, 400, { error: \"phone is required\" });\r\n    }\r\n    if (!answers || typeof answers !== \"object\") {\r\n      return json(res, 400, { error: \"answers is required\" });\r\n    }\r\n\r\n    const phoneNorm = phone.trim();\r\n    const sexNorm = normalizeSex(sex);\r\n    const ageNorm = normalizeAge(age);\r\n    const nameNorm = name == null ? null : String(name).trim() || null;\r\n\r\n    /* ---------- 标准化 answers：强制 1..20 ---------- */\r\n    const normAnswers = {};\r\n    for (let i = 1; i <= 20; i++) {\r\n      const v = answers[i] ?? answers[String(i)];\r\n      if (v == null) return json(res, 400, { error: `answer ${i} is required` });\r\n\r\n      const num = Number(v);\r\n      if (![1, 2, 3, 4].includes(num)) {\r\n        return json(res, 400, { error: `answer ${i} must be 1..4` });\r\n      }\r\n      normAnswers[i] = num;\r\n    }\r\n\r\n    /* ---------- 计分 ---------- */\r\n    const { raw, standard, level } = scoreSAS(normAnswers);\r\n\r\n    /* ---------- 写数据库（事务） ---------- */\r\n    const pool = getPool();\r\n    const conn = await pool.getConnection();\r\n\r\n    try {\r\n      await conn.beginTransaction();\r\n\r\n      // users（按 phone 去重）\r\n      await conn.query(\r\n        `\r\n        INSERT INTO users (name, sex, age, phone)\r\n        VALUES (?, ?, ?, ?)\r\n        ON DUPLICATE KEY UPDATE\r\n          name = VALUES(name),\r\n          sex  = VALUES(sex),\r\n          age  = VALUES(age)\r\n        `,\r\n        [nameNorm, sexNorm, ageNorm, phoneNorm]\r\n      );\r\n\r\n      const [uRows] = await conn.query(\r\n        `SELECT id FROM users WHERE phone = ? LIMIT 1`,\r\n        [phoneNorm]\r\n      );\r\n      if (!uRows || uRows.length === 0) throw new Error(\"User upsert failed\");\r\n      const userId = uRows[0].id;\r\n\r\n      // assessments\r\n      const [assessRes] = await conn.query(\r\n        `\r\n        INSERT INTO assessments (user_id, scale, raw_score, standard_score, level)\r\n        VALUES (?, 'SAS', ?, ?, ?)\r\n        `,\r\n        [userId, raw, standard, level]\r\n      );\r\n      const assessmentId = assessRes.insertId;\r\n\r\n      // answers（批量插入）\r\n      const rows = [];\r\n      for (let i = 1; i <= 20; i++) rows.push([assessmentId, i, normAnswers[i]]);\r\n\r\n      await conn.query(\r\n        `\r\n        INSERT INTO assessment_answers (assessment_id, question_id, answer)\r\n        VALUES ?\r\n        `,\r\n        [rows]\r\n      );\r\n\r\n      await conn.commit();\r\n\r\n      // ✅ 返回 id 供前端跳转 /result?id=...\r\n      return json(res, 200, {\r\n        ok: true,\r\n        id: assessmentId,\r\n        assessmentId,\r\n        score: { raw, standard, level },\r\n      });\r\n    } catch (e) {\r\n      await conn.rollback();\r\n      throw e;\r\n    } finally {\r\n      conn.release();\r\n    }\r\n  } catch (err) {\r\n    return json(res, 500, { error: String(err.message || err) });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}